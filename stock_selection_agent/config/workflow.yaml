# Stock Selection Agent Workflow Configuration
# 종목 선정 에이전트 워크플로우 설정 파일

version: "1.0"
name: "Expert Stock Selection Workflow"
description: "펀드매니저 수준의 종목 선정 및 밸류에이션 워크플로우"

# 전역 설정
global:
  base_path: "./stock_selection_agent"
  output_path: "./stock_selection_agent/output"
  log_level: "INFO"
  date_format: "YYYY-MM-DD"
  currency: "KRW"
  benchmark: "KOSPI"

  # 날짜 확인 설정 (필수)
  date_validation:
    required: true
    check_before_analysis: true
    instructions: |
      모든 분석 시작 전 반드시 현재 날짜를 확인해야 합니다.
      1. 시스템 날짜 또는 사용자 확인을 통해 현재 날짜 파악
      2. 데이터 검색 시 올바른 연도 사용 (예: 2026년이면 "2026년" 키워드 사용)
      3. 실적 전망 시 현재 연도 기준으로 과거/미래 구분
      4. 분석 리포트에 분석 기준일 명시

  # 데이터 신선도 검증 설정 (필수)
  data_freshness:
    required: true
    max_staleness_days: 5  # 데이터가 분석일 기준 5일 이상 오래되면 경고

    validation_rules:
      # 주가 데이터
      price_data:
        max_age_days: 3
        warning_threshold: 1
        action_on_stale: "warn_and_note"  # warn_and_note, warn_and_stop, ignore

      # 재무 데이터 (분기별 발표이므로 더 관대)
      financial_data:
        max_age_days: 45
        warning_threshold: 30
        action_on_stale: "warn_and_note"

      # 애널리스트 목표주가
      analyst_data:
        max_age_days: 30
        warning_threshold: 14
        action_on_stale: "warn_and_note"

    report_requirements:
      # 리포트에 반드시 포함해야 할 날짜 정보
      mandatory_fields:
        - analysis_date        # 분석 기준일 (오늘 날짜)
        - price_data_date      # 주가 데이터 기준일
        - financial_data_date  # 재무 데이터 기준일
        - data_freshness_note  # 데이터 신선도 참고사항

      # 데이터 기준일 표기 형식
      date_display_format: |
        ## 데이터 기준일 안내
        | 데이터 유형 | 기준일 | 신선도 |
        |------------|--------|--------|
        | 분석 기준일 | {analysis_date} | - |
        | 주가 데이터 | {price_date} | {price_freshness} |
        | 재무 데이터 | {financial_date} | {financial_freshness} |
        | 애널리스트 | {analyst_date} | {analyst_freshness} |

      # 신선도 표시 규칙
      freshness_labels:
        fresh: "최신"           # 0-1일
        recent: "최근"          # 2-3일
        acceptable: "허용범위"   # 4-7일
        stale: "⚠️ 오래됨"      # 7일+
        very_stale: "⚠️⚠️ 매우 오래됨"  # 14일+

    instructions: |
      데이터 신선도 검증 절차:
      1. 검색된 모든 데이터의 날짜를 확인
      2. 분석 기준일과 데이터 기준일 간의 차이 계산
      3. 차이가 max_age_days를 초과하면 경고 표시
      4. 리포트에 데이터 기준일과 신선도 상태 명시

      예시:
      - 분석일: 2026-02-01
      - 주가 데이터: 2026-01-19 → "⚠️ 오래됨 (13일 전)"
      - 재무 데이터: 2025-12-31 → "최신" (분기 실적 기준)

      주의사항:
      - 주가는 가능한 가장 최근 거래일 데이터 사용
      - 검색 시 "실시간", "오늘", "최근" 키워드 활용
      - 오래된 데이터 사용 시 반드시 리포트에 명시

# 분석 대상 설정
targets:
  universe:
    - code: "KOSPI"
      name: "코스피 전체"
      market: "KRX"
      count: ~900
    - code: "KOSDAQ150"
      name: "코스닥 150"
      market: "KRX"
      count: 150
    - code: "KOSPI200"
      name: "코스피 200"
      market: "KRX"
      count: 200

  # 스크리닝 필터 기본값
  screening_defaults:
    min_market_cap: 100000000000  # 1000억 이상
    min_trading_value: 1000000000  # 일평균 10억 이상
    min_listing_days: 365  # 상장 1년 이상
    exclude_sectors:
      - "스팩"
      - "리츠"
      - "관리종목"

  time_range:
    # 주의: 아래 값은 기본값이며, 분석 시점의 현재 날짜를 기준으로 동적 조정 필요
    # 예: 현재가 2026년이면 historical.end=2025, forecast.start=2026
    historical:
      start: "current_year - 5"  # 동적 계산
      end: "current_year - 1"    # 동적 계산
    forecast:
      start: "current_year"      # 동적 계산
      end: "current_year + 2"    # 동적 계산
    note: "분석 시작 전 반드시 현재 날짜를 확인하고 위 값을 동적으로 설정할 것"

# 에이전트 파이프라인 정의
pipeline:
  # Phase 0: 오케스트레이션
  - agent: "00_master_orchestrator"
    name: "Master Orchestrator"
    description: "전체 워크플로우 조율 및 에이전트 간 통합"
    instructions: "agents/00_master_orchestrator/INSTRUCTIONS.md"
    role: "orchestrator"
    inputs: []
    outputs:
      - "final_portfolio.json"
      - "execution_log.json"
    timeout: 3600
    retry: 1

  # Phase 1: 스크리닝
  - agent: "01_screening_agent"
    name: "Screening Agent"
    description: "멀티팩터 퀀트 스크리닝으로 투자 후보군 축소"
    instructions: "agents/01_screening_agent/INSTRUCTIONS.md"
    inputs: []
    outputs:
      - "screened_stocks.json"
      - "screening_report.json"
    timeout: 600
    retry: 2
    config:
      target_count: 100  # 최종 후보군 수
      factors:
        value:
          weight: 0.25
          metrics: ["PER", "PBR", "EV_EBITDA", "PSR"]
        quality:
          weight: 0.25
          metrics: ["ROE", "ROIC", "Debt_Ratio", "Interest_Coverage"]
        momentum:
          weight: 0.20
          metrics: ["Price_Mom_12M", "Earnings_Revision", "Price_Mom_1M"]
        growth:
          weight: 0.20
          metrics: ["Revenue_Growth", "EPS_Growth", "Operating_Profit_Growth"]
        size:
          weight: 0.10
          metrics: ["Market_Cap", "Trading_Volume"]

  # Phase 2: 재무 분석
  - agent: "02_financial_agent"
    name: "Financial Agent"
    description: "재무제표 기반 기업 펀더멘털 분석"
    instructions: "agents/02_financial_agent/INSTRUCTIONS.md"
    inputs:
      - "screened_stocks.json"
    outputs:
      - "financial_analysis/"
      - "financial_scores.json"
    timeout: 900
    retry: 2
    config:
      analysis_depth: "comprehensive"  # basic, standard, comprehensive
      periods: 5  # 최근 5개년
      include_quarterly: true
      ratio_categories:
        - profitability
        - liquidity
        - leverage
        - efficiency
        - growth
        - cash_flow

  # Phase 3: 산업 분석
  - agent: "03_industry_agent"
    name: "Industry Agent"
    description: "산업 구조 및 경쟁 환경 분석"
    instructions: "agents/03_industry_agent/INSTRUCTIONS.md"
    inputs:
      - "screened_stocks.json"
      - "financial_analysis/"
    outputs:
      - "industry_analysis/"
      - "competitive_position.json"
    timeout: 600
    retry: 2
    config:
      frameworks:
        - "porter_five_forces"
        - "industry_lifecycle"
        - "market_share_analysis"
      peer_comparison: true
      global_benchmark: true

  # Phase 4: DCF 밸류에이션
  - agent: "04_dcf_valuation_agent"
    name: "DCF Valuation Agent"
    description: "현금흐름할인모델 기반 내재가치 산출"
    instructions: "agents/04_dcf_valuation_agent/INSTRUCTIONS.md"
    inputs:
      - "financial_analysis/"
      - "industry_analysis/"
    outputs:
      - "dcf_valuations/"
      - "dcf_summary.json"
    timeout: 900
    retry: 2
    config:
      models:
        - "FCFF"  # Free Cash Flow to Firm
        - "FCFE"  # Free Cash Flow to Equity
      projection_years: 5
      terminal_growth_rate: 0.02  # 2%
      wacc_method: "CAPM"
      sensitivity_analysis: true
      monte_carlo_simulation: false

  # Phase 5: 상대가치 평가
  - agent: "05_relative_valuation_agent"
    name: "Relative Valuation Agent"
    description: "Peer 비교 기반 상대가치 평가"
    instructions: "agents/05_relative_valuation_agent/INSTRUCTIONS.md"
    inputs:
      - "financial_analysis/"
      - "industry_analysis/"
    outputs:
      - "relative_valuations/"
      - "peer_comparison.json"
    timeout: 600
    retry: 2
    config:
      multiples:
        - name: "PER"
          weight: 0.35
          adjustment: "earnings_quality"
        - name: "PBR"
          weight: 0.20
          adjustment: "roe_based"
        - name: "EV_EBITDA"
          weight: 0.30
          adjustment: "capital_intensity"
        - name: "PSR"
          weight: 0.15
          adjustment: "margin_based"
      peer_selection:
        method: "gics_sector"
        include_global: true
        max_peers: 10
      historical_band:
        years: 5
        percentiles: [10, 25, 50, 75, 90]

  # Phase 6: 기술적 분석
  - agent: "06_technical_agent"
    name: "Technical Agent"
    description: "가격 모멘텀 및 수급 분석"
    instructions: "agents/06_technical_agent/INSTRUCTIONS.md"
    inputs:
      - "screened_stocks.json"
    outputs:
      - "technical_analysis/"
      - "technical_signals.json"
    timeout: 600
    retry: 2
    config:
      indicators:
        trend:
          - "MA_20"
          - "MA_60"
          - "MA_120"
          - "MACD"
        momentum:
          - "RSI_14"
          - "Stochastic"
          - "Williams_R"
        volatility:
          - "Bollinger_Bands"
          - "ATR"
        volume:
          - "OBV"
          - "Volume_MA"
      supply_demand:
        - "foreign_net_buy"
        - "institutional_net_buy"
        - "short_interest"
      timeframes:
        - "daily"
        - "weekly"
        - "monthly"

  # Phase 7: 리스크 분석
  - agent: "07_risk_agent"
    name: "Risk Agent"
    description: "투자 리스크 정량화 및 평가"
    instructions: "agents/07_risk_agent/INSTRUCTIONS.md"
    inputs:
      - "financial_analysis/"
      - "technical_analysis/"
    outputs:
      - "risk_analysis/"
      - "risk_scores.json"
    timeout: 600
    retry: 2
    config:
      risk_metrics:
        market:
          - "beta"
          - "var_95"
          - "cvar_95"
          - "max_drawdown"
        credit:
          - "altman_z"
          - "debt_to_equity"
          - "interest_coverage"
        liquidity:
          - "bid_ask_spread"
          - "trading_volume"
          - "turnover_ratio"
        concentration:
          - "top_shareholder"
          - "foreign_ownership"
      stress_scenarios:
        - name: "market_crash"
          description: "시장 급락 (-20%)"
          factor: -0.20
        - name: "interest_rate_shock"
          description: "금리 급등 (+200bp)"
          factor: 0.02
        - name: "currency_depreciation"
          description: "원화 약세 (-15%)"
          factor: -0.15

  # Phase 8: 센티먼트 분석
  - agent: "08_sentiment_agent"
    name: "Sentiment Agent"
    description: "뉴스, 공시, 애널리스트 의견 분석"
    instructions: "agents/08_sentiment_agent/INSTRUCTIONS.md"
    inputs:
      - "screened_stocks.json"
    outputs:
      - "sentiment_analysis/"
      - "sentiment_scores.json"
    timeout: 600
    retry: 2
    config:
      sources:
        news:
          - "naver_news"
          - "daum_news"
          - "reuters_korea"
        disclosure:
          - "dart_filings"
          - "krx_announcements"
        analyst:
          - "consensus_ratings"
          - "target_price_changes"
          - "earnings_revisions"
      nlp_settings:
        model: "korean_finance_bert"
        sentiment_threshold: 0.6
        lookback_days: 30

# 최종 통합 설정
integration:
  scoring:
    weights:
      screening: 0.10
      financial: 0.20
      industry: 0.10
      dcf_valuation: 0.20
      relative_valuation: 0.15
      technical: 0.10
      risk: 0.10
      sentiment: 0.05

  portfolio_construction:
    max_stocks: 30
    min_conviction_score: 70  # 100점 만점
    sector_max_weight: 0.30
    single_stock_max_weight: 0.10
    rebalancing_frequency: "monthly"

# 데이터 소스 설정
data_sources:
  primary:
    - name: "KRX"
      type: "market_data"
      access: "api"
      update_frequency: "real_time"
      reliability: "high"

    - name: "DART"
      type: "financial_statements"
      access: "api"
      update_frequency: "event_driven"
      reliability: "high"

    - name: "FnGuide"
      type: "consensus"
      access: "web_scraping"
      update_frequency: "daily"
      reliability: "high"

  secondary:
    - name: "Naver Finance"
      type: "market_data"
      access: "web_scraping"
      update_frequency: "real_time"
      reliability: "medium"

    - name: "증권사 리포트"
      type: "analyst_reports"
      access: "manual"
      update_frequency: "event_driven"
      reliability: "medium"

# 에러 처리 설정
error_handling:
  data_missing:
    action: "fallback"
    fallback_methods:
      - "use_alternative_source"
      - "use_industry_average"
      - "exclude_from_analysis"
    notify: true

  valuation_failed:
    action: "flag_and_continue"
    threshold: 0.7
    notify: true

  agent_timeout:
    action: "retry_with_backoff"
    max_retries: 3
    backoff_multiplier: 2

# 알림 설정
notifications:
  on_completion:
    enabled: true
    channels: ["log"]
  on_error:
    enabled: true
    channels: ["log"]
  on_high_conviction:
    enabled: true
    channels: ["log"]
    threshold: 85

# 출력 설정
output_settings:
  format: "markdown"
  include_raw_data: false
  include_charts: true
  include_sensitivity: true
  source_citations: true
